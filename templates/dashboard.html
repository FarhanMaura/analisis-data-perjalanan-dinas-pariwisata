{% extends "base.html" %} {% block title %}Dashboard - Pengelolaan Data
Pariwisata Palembang{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %} {% block content %}
<div class="container">
  <div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div class="flash-message flash-{{ category }}">
      <i>
        {% if category == 'success' %}âœ… {% elif category == 'error' %}âŒ {%
        elif category == 'warning' %}âš ï¸ {% else %}â„¹ï¸{% endif %}
      </i>
      <span>{{ message }}</span>
    </div>
    {% endfor %} {% endif %} {% endwith %}
  </div>

  <div class="dashboard-header">
    <h1>Dashboard Analisis Data Pariwisata</h1>
    <p>Analisis data kunjungan wisatawan di Palembang</p>
  </div>

  <div class="actions">
    <a href="{{ url_for('upload') }}" class="btn btn-primary">
      <span>ğŸ“¤</span> Upload Data Baru
    </a>
    <form
      action="{{ url_for('delete_data') }}"
      method="POST"
      style="display: inline"
    >
      <button
        type="submit"
        class="btn btn-danger"
        onclick="return confirm('Yakin hapus semua data?')"
      >
        <span>ğŸ—‘ï¸</span> Hapus Semua Data
      </button>
    </form>
    <a href="{{ url_for('export_excel') }}" class="btn btn-success">
      <span>ğŸ“Š</span> Export ke Excel
    </a>
  </div>

  {% if df_empty %}
  <div class="no-data">
    <h2>ğŸ“Š Belum Ada Data</h2>
    <p>Upload data CSV terlebih dahulu untuk melihat analisis</p>
    <a href="{{ url_for('upload') }}" class="btn btn-primary"
      >Upload Data Pertama</a
    >
  </div>
  {% else %}
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number">{{ db_stats.total_records }}</div>
      <div class="stat-label">Total Data Bulanan</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ db_stats.years_available|length }}</div>
      <div class="stat-label">Tahun Tersedia</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ db_stats.total_files }}</div>
      <div class="stat-label">File Diupload</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">
        {% if db_stats.total_records and db_stats.years_available|length %} {{
        (db_stats.total_records / db_stats.years_available|length)|round|int }}
        {% else %} 0 {% endif %}
      </div>
      <div class="stat-label">Rata-rata Data per Tahun</div>
    </div>
  </div>

  <h2>Visualisasi Data</h2>
  <div class="charts-grid">
    <div class="chart-container">
      <div class="chart-title">Rata-rata Pengunjung per Bulan</div>
      <canvas id="monthlyChart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Trend Tahunan</div>
      <canvas id="yearlyChart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Distribusi Musim (ML Analysis)</div>
      <canvas id="seasonalChart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Performa Bulanan dengan Kategori Musim</div>
      <canvas id="seasonalBarChart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Perbandingan Tahun</div>
      <canvas id="comparisonChart"></canvas>
    </div>
  </div>

  <div class="suggestions-section">
    <h2>ğŸ’¡ Saran & Rekomendasi Machine Learning</h2>
    {% if ml_analysis and ml_analysis.suggestions %} {% for suggestion in
    ml_analysis.suggestions %}
    <div class="suggestion-item">{{ suggestion }}</div>
    {% endfor %} {% else %} {% for suggestion in suggestions %}
    <div class="suggestion-item">{{ suggestion }}</div>
    {% endfor %} {% endif %}
  </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const monthlyData = {{ charts_data.monthly_labels | tojson | safe }};
      const monthlyValues = {{ charts_data.monthly_values | tojson | safe }};
      const yearlyLabels = {{ charts_data.yearly_labels | tojson | safe }};
      const yearlyValues = {{ charts_data.yearly_values | tojson | safe }};

      if (monthlyData.length > 0) {
          new Chart(document.getElementById('monthlyChart'), {
              type: 'bar',
              data: {
                  labels: monthlyData,
                  datasets: [{
                      label: 'Rata-rata Pengunjung',
                      data: monthlyValues,
                      backgroundColor: 'rgba(59, 130, 246, 0.8)',
                      borderColor: 'rgba(59, 130, 246, 1)',
                      borderWidth: 2,
                      borderRadius: 8
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: { display: true, text: 'Rata-rata Pengunjung per Bulan' }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: { callback: value => value.toLocaleString('id-ID') }
                      }
                  }
              }
          });
      } else {
          document.getElementById('monthlyChart').innerHTML = '<div class="no-data"><p>ğŸ“Š Tidak ada data bulanan</p></div>';
      }

      if (yearlyLabels.length > 0) {
          new Chart(document.getElementById('yearlyChart'), {
              type: 'line',
              data: {
                  labels: yearlyLabels,
                  datasets: [{
                      label: 'Total Pengunjung',
                      data: yearlyValues,
                      backgroundColor: 'rgba(6, 182, 212, 0.2)',
                      borderColor: 'rgba(6, 182, 212, 1)',
                      borderWidth: 3,
                      tension: 0.4,
                      fill: true
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: { display: true, text: 'Trend Kunjungan Tahunan' }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: { callback: value => value.toLocaleString('id-ID') }
                      }
                  }
              }
          });
      } else {
          document.getElementById('yearlyChart').innerHTML = '<div class="no-data"><p>ğŸ“ˆ Tidak ada data tahunan</p></div>';
      }

      const seasonalCtx = document.getElementById('seasonalChart');
      if (monthlyValues.length > 0) {
          const values = monthlyValues.map(v => parseFloat(v));
          const totalVisitors = values.reduce((a, b) => a + b, 0);

          if (totalVisitors > 0) {
              const sortedValues = [...values].sort((a, b) => a - b);
              const highThreshold = sortedValues[Math.floor(sortedValues.length * 0.7)];
              const lowThreshold = sortedValues[Math.floor(sortedValues.length * 0.3)];

              let highSeasonVisitors = 0;
              let mediumSeasonVisitors = 0;
              let lowSeasonVisitors = 0;

              values.forEach((value, index) => {
                  if (value >= highThreshold) {
                      highSeasonVisitors += value;
                  } else if (value <= lowThreshold) {
                      lowSeasonVisitors += value;
                  } else {
                      mediumSeasonVisitors += value;
                  }
              });

              const highPercentage = Math.round((highSeasonVisitors / totalVisitors) * 100);
              const mediumPercentage = Math.round((mediumSeasonVisitors / totalVisitors) * 100);
              const lowPercentage = Math.round((lowSeasonVisitors / totalVisitors) * 100);

              new Chart(seasonalCtx, {
                  type: 'doughnut',
                  data: {
                      labels: [
                          `High Season (${highPercentage}%)`,
                          `Medium Season (${mediumPercentage}%)`,
                          `Low Season (${lowPercentage}%)`
                      ],
                      datasets: [{
                          data: [highPercentage, mediumPercentage, lowPercentage],
                          backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1'],
                          borderColor: '#FFFFFF',
                          borderWidth: 2
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          title: {
                              display: true,
                              text: 'Distribusi Pengunjung Berdasarkan Musim (ML Analysis)'
                          },
                          legend: {
                              position: 'bottom'
                          },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      const label = context.label || '';
                                      const value = context.parsed;
                                      return `${label}: ${value}% pengunjung`;
                                  }
                              }
                          }
                      }
                  }
              });
          } else {
              seasonalCtx.innerHTML = '<div class="no-data"><p>ğŸ“Š Tidak ada data pengunjung</p></div>';
          }
      } else {
          seasonalCtx.innerHTML = '<div class="no-data"><p>ğŸ“Š Data musim tidak tersedia</p></div>';
      }

      const seasonalBarCtx = document.getElementById('seasonalBarChart');
      if (monthlyData.length > 0 && monthlyValues.length > 0) {
          const values = monthlyValues.map(v => parseFloat(v));
          const sortedValues = [...values].sort((a, b) => a - b);
          const highThreshold = sortedValues[Math.floor(sortedValues.length * 0.7)] || 0;
          const lowThreshold = sortedValues[Math.floor(sortedValues.length * 0.3)] || 0;
          const backgroundColors = values.map(value => {
              if (value >= highThreshold) return '#FF6B6B';
              if (value <= lowThreshold) return '#45B7D1';
              return '#4ECDC4';
          });

          new Chart(seasonalBarCtx, {
              type: 'bar',
              data: {
                  labels: monthlyData,
                  datasets: [{
                      label: 'Rata-rata Pengunjung per Bulan',
                      data: values,
                      backgroundColor: backgroundColors,
                      borderColor: '#2C3E50',
                      borderWidth: 1
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: 'Performa Bulanan dengan Kategori Musim'
                      },
                      legend: {
                          display: false
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          title: {
                              display: true,
                              text: 'Jumlah Pengunjung'
                          },
                          ticks: {
                              callback: value => value.toLocaleString('id-ID')
                          }
                      }
                  }
              }
          });
      } else {
          seasonalBarCtx.innerHTML = '<div class="no-data"><p>ğŸ“Š Data tidak tersedia</p></div>';
      }

      const comparisonCtx = document.getElementById('comparisonChart');
      if (yearlyLabels.length >= 2) {
          new Chart(comparisonCtx, {
              type: 'bar',
              data: {
                  labels: yearlyLabels,
                  datasets: [{
                      label: 'Total Pengunjung',
                      data: yearlyValues,
                      backgroundColor: yearlyLabels.map((_, i) => `hsl(${i * 60}, 70%, 60%)`),
                      borderColor: yearlyLabels.map((_, i) => `hsl(${i * 60}, 70%, 50%)`),
                      borderWidth: 2,
                      borderRadius: 8
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: { display: true, text: 'Perbandingan Jumlah Pengunjung per Tahun' }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: { callback: value => value.toLocaleString('id-ID') }
                      }
                  }
              }
          });
      } else {
          comparisonCtx.innerHTML = '<div class="no-data"><p>ğŸ“ˆ Data perbandingan minimal 2 tahun</p></div>';
      }
  });
</script>
{% endblock %}
